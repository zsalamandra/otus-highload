## PostgreSQL

### authentication (Аутентификация)

#### superuser (Суперпользователь):

* **username (имя пользователя):** Имя суперпользователя, устанавливается во время инициализации (initdb) и впоследствии используется Patroni для подключения к PostgreSQL.
* **password (пароль):** Пароль для суперпользователя, устанавливается во время инициализации (initdb).
* **sslmode (режим SSL):** (Необязательный параметр) Соответствует параметру соединения sslmode, который позволяет клиенту указывать тип согласования TLS с сервером. Для получения дополнительной информации о работе каждого режима, пожалуйста, обратитесь к документации PostgreSQL. Режим по умолчанию - prefer.
* **sslkey:** (Необязательный параметр) Соответствует параметру соединения sslkey, который определяет расположение секретного ключа, используемого с сертификатом клиента.
* **sslpassword:** (Необязательный параметр) Соответствует параметру соединения sslpassword, который определяет пароль для секретного ключа, указанного в sslkey.
* **sslcert:** (Необязательный параметр) Соответствует параметру соединения sslcert, который определяет расположение клиентского сертификата.
* **sslrootcert:** (Необязательный параметр) Соответствует параметру соединения sslrootcert, который определяет расположение файла, содержащего один или несколько сертификатов центров сертификации (CA), которые клиент будет использовать для проверки сертификата сервера.
* **sslcrl:** (Необязательный параметр) Соответствует параметру соединения sslcrl, который определяет расположение файла, содержащего список отзыва сертификатов (CRL). Клиент отклонит подключение к любому серверу, чей сертификат присутствует в этом списке.
* **sslcrldir:** (Необязательный параметр) Соответствует параметру соединения sslcrldir, который определяет расположение каталога с файлами, содержащими списки отзыва сертификатов. Клиент отклонит подключение к любому серверу, чей сертификат присутствует в этом списке.
* **sslnegotiation:** (Необязательный параметр) Соответствует параметру соединения sslnegotiation, который контролирует, как согласовывается SSL-шифрование с сервером, если используется SSL.
* **gssencmode:** (Необязательный параметр) Соответствует параметру соединения gssencmode, который определяет, будет ли и с каким приоритетом устанавливаться безопасное GSS TCP/IP соединение с сервером.
* **channel_binding:** (Необязательный параметр) Соответствует параметру соединения channel_binding, который контролирует использование привязки канала клиентом.


#### replication (Репликация):

* **username (имя пользователя):** Имя пользователя для репликации; пользователь будет создан во время инициализации. Реплики будут использовать этого пользователя для доступа к источнику репликации через потоковую репликацию.
* **password (пароль):** Пароль пользователя для репликации; пользователь будет создан во время инициализации.
* **sslmode (режим SSL):** (Необязательный параметр) Соответствует параметру соединения sslmode, который позволяет клиенту указывать тип согласования TLS с сервером. Для получения дополнительной информации о работе каждого режима, пожалуйста, обратитесь к документации PostgreSQL. Режим по умолчанию - prefer.
* **sslkey:** (Необязательный параметр) Соответствует параметру соединения sslkey, который определяет расположение секретного ключа, используемого с сертификатом клиента.
* **sslpassword:** (Необязательный параметр) Соответствует параметру соединения sslpassword, который определяет пароль для секретного ключа, указанного в sslkey.
* **sslcert:** (Необязательный параметр) Соответствует параметру соединения sslcert, который определяет расположение клиентского сертификата.
* **sslrootcert:** (Необязательный параметр) Соответствует параметру соединения sslrootcert, который определяет расположение файла, содержащего один или несколько сертификатов центров сертификации (CA), которые клиент будет использовать для проверки сертификата сервера.
* **sslcrl:** (Необязательный параметр) Соответствует параметру соединения sslcrl, который определяет расположение файла, содержащего список отзыва сертификатов (CRL). Клиент отклонит подключение к любому серверу, чей сертификат присутствует в этом списке.
* **sslcrldir:** (Необязательный параметр) Соответствует параметру соединения sslcrldir, который определяет расположение каталога с файлами, содержащими списки отзыва сертификатов. Клиент отклонит подключение к любому серверу, чей сертификат присутствует в этом списке.
* **sslnegotiation:** (Необязательный параметр) Соответствует параметру соединения sslnegotiation, который контролирует, как согласовывается SSL-шифрование с сервером, если используется SSL.
* **gssencmode:** (Необязательный параметр) Соответствует параметру соединения gssencmode, который определяет, будет ли и с каким приоритетом устанавливаться безопасное GSS TCP/IP соединение с сервером.
* **channel_binding:** (Необязательный параметр) Соответствует параметру соединения channel_binding, который контролирует использование привязки канала клиентом.


#### rewind (Перемотка):

* **username (имя пользователя):** (Необязательный параметр) Имя пользователя для pg\_rewind; пользователь будет создан во время инициализации PostgreSQL 11+ и будут предоставлены все необходимые разрешения.
* **password (пароль):** (Необязательный параметр) Пароль для пользователя для pg\_rewind; пользователь будет создан во время инициализации.
* **sslmode (режим SSL):** (Необязательный параметр) Соответствует параметру соединения sslmode, который позволяет клиенту указывать тип согласования TLS с сервером. Для получения дополнительной информации о работе каждого режима, пожалуйста, обратитесь к документации PostgreSQL. Режим по умолчанию - prefer.
* **sslkey:** (Необязательный параметр) Соответствует параметру соединения sslkey, который определяет расположение секретного ключа, используемого с сертификатом клиента.
* **sslpassword:** (Необязательный параметр) Соответствует параметру соединения sslpassword, который определяет пароль для секретного ключа, указанного в sslkey.
* **sslcert:** (Необязательный параметр) Соответствует параметру соединения sslcert, который определяет расположение клиентского сертификата.
* **sslrootcert:** (Необязательный параметр) Соответствует параметру соединения sslrootcert, который определяет расположение файла, содержащего один или несколько сертификатов центров сертификации (CA), которые клиент будет использовать для проверки сертификата сервера.
* **sslcrl:** (Необязательный параметр) Соответствует параметру соединения sslcrl, который определяет расположение файла, содержащего список отзыва сертификатов (CRL). Клиент отклонит подключение к любому серверу, чей сертификат присутствует в этом списке.
* **sslcrldir:** (Необязательный параметр) Соответствует параметру соединения sslcrldir, который определяет расположение каталога с файлами, содержащими списки отзыва сертификатов. Клиент отклонит подключение к любому серверу, чей сертификат присутствует в этом списке.
* **sslnegotiation:** (Необязательный параметр) Соответствует параметру соединения sslnegotiation, который контролирует, как согласовывается SSL-шифрование с сервером, если используется SSL.
* **gssencmode:** (Необязательный параметр) Соответствует параметру соединения gssencmode, который определяет, будет ли и с каким приоритетом устанавливаться безопасное GSS TCP/IP соединение с сервером.
* **channel_binding:** (Необязательный параметр) Соответствует параметру соединения channel_binding, который контролирует использование привязки канала клиентом.


### callbacks (Обратные вызовы):

Скрипты обратного вызова для запуска при определенных действиях. Patroni будет передавать действие, роль и имя кластера. (См. scripts/aws.py в качестве примера того, как их писать.)

* **on\_reload:** Запускать этот скрипт при перезагрузке конфигурации.
* **on\_restart:** Запускать этот скрипт при перезапуске PostgreSQL (без изменения роли).
* **on\_role\_change:** Запускать этот скрипт, когда PostgreSQL повышается или понижается в должности.
* **on\_start:** Запускать этот скрипт при запуске PostgreSQL.
* **on\_stop:** Запускать этот скрипт при остановке PostgreSQL.
* **connect\_address:** IP-адрес + порт, через который Postgres доступен с других узлов и приложений.
* **proxy\_address:** IP-адрес + порт, через который доступен пул соединений (например, pgbouncer), работающий рядом с Postgres. Значение записывается в ключ member в DCS как proxy\_url и может быть использовано/полезно для обнаружения сервисов.
* **create\_replica\_methods:** Упорядоченный список методов создания для превращения узла Patroni в новую реплику. "basebackup" - метод по умолчанию; предполагается, что другие методы относятся к скриптам, каждый из которых настроен как отдельный элемент конфигурации. См. документацию по пользовательским методам создания реплик для дальнейшего объяснения.
* **data\_dir:** Расположение каталога данных Postgres, существующего или подлежащего инициализации Patroni.
* **config\_dir:** Расположение каталога конфигурации Postgres, по умолчанию - каталог данных. Должен быть доступен для записи Patroni.
* **bin\_dir:** (Необязательный параметр) Путь к бинарным файлам PostgreSQL (pg\_ctl, initdb, pg\_controldata, pg\_basebackup, postgres, pg\_isready, pg\_rewind). Если не указан или является пустой строкой, для поиска исполняемых файлов будет использоваться переменная среды PATH.
* **bin\_name:** (Необязательный параметр) Позволяет переопределить имена бинарных файлов Postgres, если вы используете пользовательский дистрибутив Postgres:
    * **pg\_ctl:** (Необязательный параметр) Пользовательское имя для бинарного файла pg\_ctl.
    * **initdb:** (Необязательный параметр) Пользовательское имя для бинарного файла initdb.
    * **pgcontroldata:** (Необязательный параметр) Пользовательское имя для бинарного файла pg\_controldata.
    * **pg\_basebackup:** (Необязательный параметр) Пользовательское имя для бинарного файла pg\_basebackup.
    * **postgres:** (Необязательный параметр) Пользовательское имя для бинарного файла postgres.
    * **pg\_isready:** (Необязательный параметр) Пользовательское имя для бинарного файла pg\_isready.
    * **pg\_rewind:** (Необязательный параметр) Пользовательское имя для бинарного файла pg\_rewind.
* **listen:** IP-адрес + порт, который прослушивает Postgres; должен быть доступен с других узлов кластера, если вы используете потоковую репликацию. Допускается несколько адресов, разделенных запятыми, при условии, что компонент порта добавляется после последнего через двоеточие, т.е. listen: 127.0.0.1,127.0.0.2:5432. Patroni будет использовать первый адрес из этого списка для установления локальных соединений с узлом PostgreSQL.
* **use\_unix\_socket:** Указывает, что Patroni должен предпочитать использовать unix-сокеты для подключения к кластеру. Значение по умолчанию - false. Если определен unix\_socket\_directories, Patroni будет использовать первое подходящее значение из него для подключения к кластеру и перейдет на tcp, если ничего не подходит. Если unix\_socket\_directories не указан в postgresql.parameters, Patroni будет предполагать, что следует использовать значение по умолчанию, и опустит хост из параметров соединения.
* **use\_unix\_socket\_repl:** Указывает, что Patroni должен предпочитать использовать unix-сокеты для подключения пользователя репликации к кластеру. Значение по умолчанию - false. Если определен unix\_socket\_directories, Patroni будет использовать первое подходящее значение из него для подключения к кластеру и перейдет на tcp, если ничего не подходит. Если unix\_socket\_directories не указан в postgresql.parameters, Patroni будет предполагать, что следует использовать значение по умолчанию, и опустит хост из параметров соединения.
* **pgpass:** Путь к файлу паролей .pgpass. Patroni создает этот файл перед выполнением pg\_basebackup, скрипта post\_init и при некоторых других обстоятельствах. Расположение должно быть доступно для записи Patroni.
* **recovery\_conf:** Дополнительные параметры конфигурации, записываемые в recovery.conf при настройке follower.
* **custom\_conf:** Путь к необязательному пользовательскому файлу postgresql.conf, который будет использоваться вместо postgresql.base.conf. Файл должен существовать на всех узлах кластера, быть читаемым PostgreSQL и будет включен из своего местоположения в реальный postgresql.conf. Обратите внимание, что Patroni не будет отслеживать изменения в этом файле и не будет создавать его резервную копию. Однако его параметры все еще могут быть переопределены собственными средствами конфигурации Patroni - см. динамическую конфигурацию для получения подробной информации.
* **parameters:** Параметры конфигурации (GUC) для Postgres в формате {ssl: "on", ssl\_cert\_file: "cert\_file"}.
* **pg\_hba:** Список строк, которые Patroni будет использовать для создания pg\_hba.conf. Patroni игнорирует этот параметр, если параметр PostgreSQL hba\_file установлен в значение, отличное от значения по умолчанию. Вместе с динамической конфигурацией этот параметр упрощает управление pg\_hba.conf.
    * `host all all 0.0.0.0/0 md5`
    * `host replication replicator 127.0.0.1/32 md5`: Строка, подобная этой, требуется для репликации.
* **pg\_ident:** Список строк, которые Patroni будет использовать для создания pg\_ident.conf. Patroni игнорирует этот параметр, если параметр PostgreSQL ident\_file установлен в значение, отличное от значения по умолчанию. Вместе с динамической конфигурацией этот параметр упрощает управление pg\_ident.conf.
    * `mapname1 systemname1 pguser1`
    * `mapname1 systemname2 pguser2`
* **pg\_ctl\_timeout:** Как долго pg\_ctl должен ждать при запуске, остановке или перезапуске. Значение по умолчанию - 60 секунд.
* **use\_pg\_rewind:** Попытаться использовать pg\_rewind на бывшем лидере, когда он присоединяется к кластеру в качестве реплики. Либо кластер должен быть инициализирован с контрольными суммами страниц данных (--data-checksums для initdb) и/или wal\_log\_hints должны быть установлены в on, иначе pg\_rewind не будет работать.
* **remove\_data\_directory\_on\_rewind\_failure:** Если этот параметр включен, Patroni удалит каталог данных PostgreSQL и воссоздаст реплику. В противном случае он попытается следовать за новым лидером. Значение по умолчанию - false.
* **remove\_data\_directory\_on\_diverged\_timelines:** Patroni удалит каталог данных PostgreSQL и воссоздаст реплику, если заметит, что линии времени расходятся и бывший основной сервер не может начать потоковую передачу с нового основного сервера. Этот параметр полезен, когда pg\_rewind не может быть использован. При выполнении проверки расхождения линий времени в PostgreSQL v10 и более ранних версиях Patroni попытается подключиться с учетными данными репликации к базе данных "postgres". Следовательно, такой доступ должен быть разрешен в pg\_hba.conf. Значение по умолчанию - false.
* **replica\_method:** Для каждого create\_replica\_methods, отличного от basebackup, вы должны добавить раздел конфигурации с тем же именем. Как минимум, он должен включать "command" с полным путем к фактическому скрипту для выполнения. Другие параметры конфигурации будут переданы скрипту в виде "parameter=value".
* **pre\_promote:** Скрипт ограждения, который выполняется во время переключения при отказе после получения блокировки лидера, но перед повышением реплики. Если скрипт завершается с ненулевым кодом, Patroni не повышает реплику и удаляет ключ лидера из DCS.
* **before\_stop:** Скрипт, который выполняется непосредственно перед остановкой postgres. В отличие от обратного вызова, этот скрипт выполняется синхронно, блокируя завершение работы до его завершения. Код возврата этого скрипта не влияет на то, будет ли продолжено завершение работы после этого.


## REST API

### restapi:

* **connect\_address:** IP-адрес (или имя хоста) и порт для доступа к REST API Patroni. Все члены кластера должны иметь возможность подключиться к этому адресу, поэтому, если настройка Patroni не предназначена для демонстрации внутри localhost, этот адрес должен быть адресом, отличным от "localhost" или loopback (например: "localhost" или "127.0.0.1"). Он может служить конечной точкой для HTTP-проверок работоспособности (читайте ниже о параметре REST API "listen"), а также для пользовательских запросов (непосредственно или через REST API), а также для проверок работоспособности, выполняемых членами кластера во время выборов лидера (например, для определения того, работает ли лидер, или есть ли узел, у которого WAL-позиция опережает ту, которая выполняет запрос; и т.д.). Адрес connect\_address помещается в ключ member в DCS, что позволяет преобразовать имя члена в адрес для подключения к его REST API.
* **listen:** IP-адрес (или имя хоста) и порт, который Patroni будет прослушивать для REST API - для обеспечения также тех же проверок работоспособности и обмена сообщениями между участвующими узлами, как описано выше. для предоставления информации о проверке работоспособности для HAProxy (или любого другого балансировщика нагрузки, способного выполнять HTTP-проверки "OPTION" или "GET").
* **authentication (Аутентификация):** (необязательный параметр)
    * **username:** Имя пользователя для Basic-auth для защиты небезопасных конечных точек REST API.
    * **password:** Пароль для Basic-auth для защиты небезопасных конечных точек REST API.
    * **certfile:** (необязательный параметр): Указывает файл с сертификатом в формате PEM. Если certfile не указан или оставлен пустым, API-сервер будет работать без SSL.
    * **keyfile:** (необязательный параметр): Указывает файл с секретным ключом в формате PEM.
    * **keyfile\_password:** (необязательный параметр): Указывает пароль для расшифровки keyfile.
    * **cafile:** (необязательный параметр): Указывает файл с CA\_BUNDLE с сертификатами доверенных ЦС для использования при проверке сертификатов клиентов.
    * **ciphers:** (необязательный параметр): Указывает разрешенные наборы шифров (например, "ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:!SSLv1:!SSLv2:!SSLv3:!TLSv1:!TLSv1.1")
    * **verify\_client:** (необязательный параметр): none (по умолчанию), optional или required. Если установлено значение none, REST API не будет проверять сертификаты клиентов. Если требуется (required), сертификаты клиентов требуются для всех RE

## Watchdog (Сторожевой таймер)

* **mode:** `off`, `automatic` или `required`.
    * `off`: Сторожевой таймер отключен.
    * `automatic`: Сторожевой таймер будет использоваться, если доступен, в противном случае будет проигнорирован.
    * `required`: Узел не станет лидером, если не удастся успешно включить сторожевой таймер.
* **device:** Путь к устройству сторожевого таймера. По умолчанию `/dev/watchdog`.
* **safety\_margin:** Количество секунд запаса между срабатыванием сторожевого таймера и истечением срока действия ключа лидера.


## Tags (Теги)

* **clonefrom:** `true` или `false`. Если установлено значение `true`, другие узлы могут предпочесть использовать этот узел для начальной загрузки (брать `pg_basebackup` с него). Если есть несколько узлов с тегом `clonefrom`, установленным в `true`, узел для начальной загрузки будет выбран случайным образом. Значение по умолчанию `false`.
* **noloadbalance:** `true` или `false`. Если установлено значение `true`, узел будет возвращать HTTP-код состояния 503 для GET-запроса к health-check REST API `/replica` и, следовательно, будет исключен из балансировки нагрузки. Значение по умолчанию `false`.
* **replicatefrom:** Имя другой реплики, с которой нужно реплицироваться. Используется для поддержки каскадной репликации.
* **nosync:** `true` или `false`. Если установлено значение `true`, узел никогда не будет выбран в качестве синхронной реплики.
* **nofailover:** `true` или `false`. Определяет, разрешено ли этому узлу участвовать в гонке за лидерство и становиться лидером. По умолчанию `false`, что означает, что этот узел *может* участвовать в гонках за лидерство.
* **failover\_priority:** Целое число, определяющее приоритет, который должен иметь этот узел во время переключения при отказе. Узлы с более высоким приоритетом будут предпочтительнее узлов с более низким приоритетом, если они получили/воспроизвели одинаковый объем WAL. Однако узлы с более высокими значениями receive/replay LSN (номером последовательности записи) предпочтительны независимо от их приоритета. Если `failover_priority` равен 0 или отрицательному числу, такому узлу не разрешено участвовать в гонке за лидерство и становиться лидером (аналогично `nofailover: true`).
* **nostream:** `true` или `false`. Если установлено значение `true`, узел не будет использовать протокол репликации для потоковой передачи WAL. Вместо этого он будет полагаться на восстановление из архива (если настроена `restore_command`) и опрос `pg_wal`/`pg_xlog`. Это также отключает копирование и синхронизацию постоянных слотов логической репликации на самом узле и всех его каскадных репликах. Установка этого тега на основном узле не имеет эффекта.

